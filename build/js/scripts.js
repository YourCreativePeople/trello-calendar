function getWeeks(){for(var e=moment(),a=moment(e).isoWeekday(1),r=a,t=2,o=new Array,n=0;t>n;n++){var s=new Object;s.WeekNumber=r.isoWeek();for(var d=new Array,l=0;5>l;l++)d.push(r),s.Days=d,Days.push(r),r=moment(r).add("days",1);o.push(s),r=moment(r).add("days",2)}trelloCards.set({weeks:o})}function getDateIndex(e){for(var a=0;a<Days.length;a++)if(Days[a].isSame(moment(e),"day"))return a;return-1}function cardIsInRange(e){return!e.StartDate.isAfter(Days[Days.length-1],"day")&&!e.EndDate.isBefore(Days[0],"day")}function newRow(){var e=new Object;e.Columns=new Array;for(var a=0;a<Days.length;a++){var r=new Object;r.Span=1,r.StartDate=Days[a],r.EndDate=Days[a],r.BoardID="",e.Columns.push(r)}return e}function rowToUse(e,a){for(var r=0;r<e.Rows.length;r++){for(var t=!0,o=e.Rows[r],n=0;n<o.Columns.length;n++){var s=o.Columns[n];if(""!==s.BoardID&&!a.StartDate.isAfter(s.EndDate,"day")&&!a.EndDate.isBefore(s.StartDate,"day")){t=!1;break}}if(t)return o}var d=newRow();return e.Rows.push(d),d}function addToColumn(e,a){var r,t=new Array;a.StartDate.isBefore(Days[0],"day")&&(a.StartDate=moment(Days[0]));for(var o=0;o<e.Columns.length;o++){var n=e.Columns[o].StartDate.isSame(a.StartDate,"day"),s=e.Columns[o].StartDate.isAfter(a.StartDate,"day"),d=e.Columns[o].StartDate.isSame(a.EndDate,"day");if(n&&(r=e.Columns[o],r.BoardID=a.idBoard,r.Span=1,d))break;if(s&&(r.EndDate=e.Columns[o].StartDate,r.Span=r.Span+1,t.push(o),d))break}for(var o=t.length-1;o>=0;o--)e.Columns.splice(t[o],1)}function processMemberCards(e){e.Rows=new Array;for(var a=0;a<e.cards.length;a++){var r=e.cards[a];r.EndDate=moment(r.due),r.StartDate=moment(r.EndDate).add("days",-1),cardIsInRange(r)&&addToColumn(rowToUse(e,r),r)}}var orgData,trelloCards=new Ractive({el:"container",template:"#template",data:{org:orgData,tempFunction:function(){},getBoard:function(e){return""!==trelloCards.data.org.boards[e].name?trelloCards.data.org.boards[e].name:"Board in another org"},formatDate:function(e){return e.format("DD - MMM")},renderRows:function(e){for(var a="",r=0;r<e.Rows.length;r++){var t=e.Rows[r];a+="<tr>",0==r&&(a+='<td rowspan="'+e.Rows.length.toString()+'">'+e.fullName+"</td>");for(var o=0;o<t.Columns.length;o++){var n=t.Columns[o];a+='<td colspan="'+n.Span.toString()+'">';var s=n.BoardID;if(""!==s){var d=trelloCards.data.org.boards[n.BoardID];a+=""!==d.name?d.name:"Board in another org"}a+="</td>"}a+="</tr>"}return a}}});trelloCards.on({change:function(){}}),trelloCards.observe("org",function(){}),trelloCards.observe("org.boards",function(){trelloCards.data.org&&(localStorage.trelloCalendar=JSON.stringify(trelloCards.data.org))});var onAuthorize=function(){updateLoggedIn(),Trello.get("organizations/ycp",{fields:"displayName,url",boards:"open",board_fields:"name,desc,shortUrl",members:"all",member_fields:"username,fullName"},function(e){var a=e.boards,r={};delete e.boards,e.boards={};for(var t=0;t<a.length;t++)r[a[t].id]=a[t],delete r[a[t].id].id;e.boards=r,getWeeks(),$.each(e.members,function(a,r){r.cards=new Array,Trello.get("members/"+r.id+"/cards",{fields:"name,url,due,desc,idBoard"},function(a){for(var t=a.length-1;t>=0;t--){var o=a[t];null===o.due?a.splice(t,1):o.due=new Date(o.due)}r.cards=a,processMemberCards(r),trelloCards.set({org:e})})}),trelloCards.update()})},updateLoggedIn=function(){Trello.members.get("me",function(e){$("#fullName").text(e.fullName)});var e=Trello.authorized();$(".loggedout").toggle(!e),$(".loggedin").toggle(e)},logout=function(){Trello.deauthorize(),updateLoggedIn()};Trello.authorize({interactive:!1,success:onAuthorize}),$("#connectLink").click(function(){Trello.authorize({type:"popup",success:onAuthorize})}),Date.prototype.getWeekNumber=function(){var e=new Date(+this);return e.setHours(0,0,0),e.setDate(e.getDate()+4-(e.getDay()||7)),Math.ceil(((e-new Date(e.getFullYear(),0,1))/864e5+1)/7)};var Days=new Array;$("#disconnect").click(logout);